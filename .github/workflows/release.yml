name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    name: Build and Publish Release
    runs-on: ubuntu-latest
    # Avoid overlapping releases on main
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Resolve next release version
        id: version
        run: |
          set -euo pipefail

          # If this commit is already tagged, do nothing
          if git describe --tags --exact-match >/dev/null 2>&1; then
            echo "Current commit is already tagged; skipping release."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          raw_version="$(git cliff --config cliff.toml --bumped-version --unreleased | tr -d '\r\n')"
          version="${raw_version#v}"
          if [ -z "$version" ]; then
            echo "Failed to resolve next version with git-cliff."
            exit 1
          fi

          tag="v${version}"
          if git rev-parse "refs/tags/${tag}" >/dev/null 2>&1; then
            echo "Tag ${tag} already exists; skipping release."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "archive_name=ignition-workflows-${version}.zip" >> "$GITHUB_OUTPUT"

      # Prevent workflow re-run loops when we commit CHANGELOG.md
      - name: Skip if triggered by changelog commit
        if: steps.version.outputs.skip != 'true'
        id: botcheck
        run: |
          set -euo pipefail
          author_email="$(git log -1 --pretty=format:%ae)"
          author_name="$(git log -1 --pretty=format:%an)"
          subject="$(git log -1 --pretty=format:%s)"
          if [ "$author_name" = "github-actions[bot]" ] || [ "$author_email" = "41898282+github-actions[bot]@users.noreply.github.com" ]; then
            echo "Last commit is by github-actions[bot]; skipping to avoid loops."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Optional: also skip if subject matches our changelog commit message
          if echo "$subject" | grep -q "^chore(release): update changelog"; then
            echo "Last commit looks like a changelog update; skipping to avoid loops."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        if: steps.version.outputs.skip != 'true' && steps.botcheck.outputs.skip != 'true'
        run: |
          set -euo pipefail
          mkdir -p dist
          git cliff \
            --config cliff.toml \
            --unreleased \
            --tag "${{ steps.version.outputs.tag }}" \
            --strip header \
            > dist/release-notes.md

      - name: Generate CHANGELOG.md
        if: steps.version.outputs.skip != 'true' && steps.botcheck.outputs.skip != 'true'
        run: |
          set -euo pipefail
          # Full deterministic changelog for the repo
          git cliff \
            --config cliff.toml \
            --tag "${{ steps.version.outputs.tag }}" \
            > CHANGELOG.md

      - name: Commit CHANGELOG.md
        if: steps.version.outputs.skip != 'true' && steps.botcheck.outputs.skip != 'true'
        run: |
          set -euo pipefail
          if git diff --quiet -- CHANGELOG.md; then
            echo "No CHANGELOG.md changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "chore(release): update changelog for ${{ steps.version.outputs.tag }}"
          git push origin HEAD:main

      - name: Build release artifact
        if: steps.version.outputs.skip != 'true' && steps.botcheck.outputs.skip != 'true'
        run: |
          set -euo pipefail
          mkdir -p dist
          (
            cd projects/workflows
            zip -r "../../dist/${{ steps.version.outputs.archive_name }}" .
          )

      - name: Create and push tag
        if: steps.version.outputs.skip != 'true' && steps.botcheck.outputs.skip != 'true'
        run: |
          set -euo pipefail
          git fetch origin main --force
          git checkout main
          git pull --ff-only origin main

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag }}" -m "Release ${{ steps.version.outputs.tag }}"
          git push origin "${{ steps.version.outputs.tag }}"

      - name: Publish GitHub release
        if: steps.version.outputs.skip != 'true' && steps.botcheck.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body_path: dist/release-notes.md
          files: dist/${{ steps.version.outputs.archive_name }}
