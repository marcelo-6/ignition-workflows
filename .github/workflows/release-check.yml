name: Release Check

on:
  pull_request:
    branches:
      - main
  merge_group:
    branches:
      - main

permissions:
  contents: read

jobs:
  release-check:
    name: Validate Release Pipeline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff

      - name: Resolve next release version
        id: version
        run: |
          set -euo pipefail
          raw_version="$(git cliff --config cliff.toml --bumped-version --unreleased | tr -d '\r\n')"
          version="${raw_version#v}"
          if [ -z "$version" ]; then
            echo "Failed to resolve next version with git-cliff."
            exit 1
          fi

          tag="v${version}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "archive_name=ignition-workflows-${version}.zip" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        run: |
          set -euo pipefail
          mkdir -p dist
          git cliff \
            --config cliff.toml \
            --unreleased \
            --tag "${{ steps.version.outputs.tag }}" \
            --strip header \
            > dist/release-notes.md
          test -s dist/release-notes.md

      - name: Build release artifact
        run: |
          set -euo pipefail
          mkdir -p dist
          (
            cd projects/workflows
            zip -r "../../dist/${{ steps.version.outputs.archive_name }}" .
          )
          test -f "dist/${{ steps.version.outputs.archive_name }}"
